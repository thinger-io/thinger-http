name: Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  coverage:
    runs-on: self-hosted
    container:
      image: thinger/compiler:mold-latest

    steps:
      - uses: actions/checkout@v4

      - name: Configure with coverage
        run: cmake -B build -DCMAKE_BUILD_TYPE=Debug -DTHINGER_HTTP_ENABLE_COVERAGE=ON

      - name: Build
        run: cmake --build build -j$(nproc)

      - name: Run tests
        run: ctest --test-dir build --output-on-failure --timeout 300

      - name: Generate coverage report
        run: |
          lcov --capture --directory build --output-file build/coverage.info --ignore-errors source,mismatch,negative,gcov
          lcov --extract build/coverage.info '*/thinger/*' --output-file build/coverage_filtered.info --ignore-errors unused
          genhtml build/coverage_filtered.info --output-directory build/coverage_html --ignore-errors negative,mismatch
          lcov --summary build/coverage_filtered.info 2>&1 | tee build/coverage_summary.txt

      - name: Extract coverage percentage
        id: coverage
        run: |
          COVERAGE=$(grep -Po 'lines\.*:\s*\K[0-9.]+' build/coverage_summary.txt | head -1)
          echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Coverage: $COVERAGE%"

      - name: Upload coverage HTML report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html-report
          path: build/coverage_html/

      - name: Update coverage badge
        if: github.ref == 'refs/heads/main'
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_SECRET }}
          gistID: ${{ vars.COVERAGE_GIST_ID }}
          filename: coverage.json
          label: coverage
          message: ${{ steps.coverage.outputs.percentage }}%
          valColorRange: ${{ steps.coverage.outputs.percentage }}
          minColorRange: 40
          maxColorRange: 90

  deploy-pages:
    if: github.ref == 'refs/heads/main'
    needs: coverage
    runs-on: ubuntu-latest

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Download coverage report
        uses: actions/download-artifact@v4
        with:
          name: coverage-html-report
          path: coverage

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: coverage

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
